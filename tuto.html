<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Mon 1er jeu Phaser</title>
        <script
            src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js">
        </script>
        <style type="text/css"> 
            body { margin: 0; }
        </style>
    </head>


    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,
                width: 1200, height: 800,
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 500 },
                    debug: true
                    }
                },
                input:{gamepad:true},

                scene: {preload: preload, create: create, update: update }

               

            };

            new Phaser.Game(config);

            function preload(){
                this.load.spritesheet('perso','assets/perso.png',
                { frameWidth: 32, frameHeight: 32 });
                this.load.image('fond', 'assets/background.png')
                this.load.image("Phaser_tileset", "assets/Tileset.png");
                this.load.tilemapTiledJSON("carte", "assets/Map_Tiled.json");
            }



            var playerStats = {
 


                // player horizontal speed
                playerSpeed: 200,

                // player force
                playerJump: 250
}




            var cursors;
            var gameOver;

            gameOver=false;

            function create(){


                this.add.image(800, 800, 'fond'); 
                const carteDuNiveau = this.add.tilemap("carte");

                const tileset = carteDuNiveau.addTilesetImage(
                    "tuiles_de_jeu",
                    "Phaser_tileset"
                );



                const calque_plateformes = carteDuNiveau.createLayer(
                    "sol",
                    tileset
                );

                const calque_deco = carteDuNiveau.createLayer(
                    "Obstacle",
                    tileset
                );



                calque_plateformes.setCollisionByProperty({estSolide: true});

                

                //spawn du joueur
                this.player = this.physics.add.sprite(50, 1520, 'perso');

                this.player.setBounce(0.05);
                this.player.setCollideWorldBounds(false);


                this.physics.add.collider(this.player, calque_plateformes); 


                // redimentionnement du monde avec les dimensions calculées via tiled
                this.physics.world.setBounds(0, 0, 1600, 1600);
                //  ajout du champs de la caméra de taille identique à celle du monde
                this.cameras.main.setBounds(0, 0, 1600, 1600);
                // ancrage de la caméra sur le joueur
                this.cameras.main.startFollow(this.player); 


                this.onWall=false;
                this.canJump = true;
                this.canWallJump = false;
                this.ancored = false;
                this.walljumpCooldown = 0;
                this.ancorTimer =0;


                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [ { key: 'perso', frame: 4 } ],
                    frameRate: 20
                });
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                    frameRate: 10,
                    repeat: -1
                });
                
                cursors = this.input.keyboard.createCursorKeys();


            }







            function update(){

                this.walljumpCooldown = this.walljumpCooldown + 1
                this.ancorTimer = this.ancorTimer +1

                


                console.log("cooldown"+ this.walljumpCooldown);
                console.log("jump"+ this.canJump);
                console.log("walljump"+ this.canWallJump);
                console.log("wall"+ this.onWall);



                

                if (gameOver){return;}

                if (cursors.left.isDown){ //si la touche gauche est appuyée
                    this.player.setVelocityX(-playerStats.playerSpeed); //alors vitesse négative en X
                    this.player.anims.play('left', true); //et animation => gauche
                }
                else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
                    this.player.setVelocityX(playerStats.playerSpeed); //alors vitesse positive en X
                    this.player.anims.play('right', true); //et animation => droite

                }
                else{ // sinon
                    this.player.setVelocityX(0); //vitesse nulle
                    this.player.anims.play('turn'); //animation fait face caméra
                }


                // Regular jump
                if ((cursors.up.isDown && this.player.body.blocked.down) ){
                    //si touche haut appuyée ET que le perso touche le sol
                    this.player.setVelocityY(-playerStats.playerJump); //alors vitesse verticale négative


                    // hero can't jump anymore
                    this.canJump = false;

                    // hero is not on the wall anymore
                    




                }
                if(this.walljumpCooldown<80){

                this.canWallJump = false;
                }
                //Ancor
                if (((cursors.left.isDown||cursors.right.isDown) && this.onWall==true && this.ancorTimer> 80)){
                    this.player.setVelocityY(0); //alors vitesse verticale négative

                    this.ancored = true;

                    this.ancorTimer = 0;

                    this.canWallJump = true;

                    




                }
                
                //wall jump
                if (this.ancored == true && cursors.up.isDown && this.canWallJump){
                    this.player.setVelocityY(-playerStats.playerJump); //alors vitesse verticale négative

                    this.ancored = false;

                    // hero can't jump anymore
                    this.canWallJump = false;

                    // hero is not on the wall anymore
                    this.onWall = false;

                    this.walljumpCooldown = 0;
                }

                if(this.onWall == false){
                    this.ancored=false
                }

                if(this.ancored == true){
                    this.player.setVelocityY(0);
                }
                

                if (cursors.down.isDown && !this.player.body.touching.down){ //si la touche bas est appuyée en saut
                    this.player.setVelocityY(450); 
                } 

                if(this.player.body.blocked.down){
 
                    // hero can jump
                    this.canJump = true;

                    this.canWallJump = true;

                    // hero not on the wall
                    this.onWall = false;
                }



                if((this.player.body.blocked.left && !this.player.body.blocked.down)||(this.player.body.blocked.right && !this.player.body.blocked.down)){

                    this.onWall = true;
                }else{
                    this.onWall = false;
                }


            }









        </script>
    </body>
</html>